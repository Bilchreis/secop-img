\documentclass[margin=10pt]{standalone}
\usepackage{color,xcolor}

\usepackage[utf8]{inputenc} 

\input{../praeambel}

\newcommand{\propsize}{\footnotesize}
\newcommand{\proptextw}{2.2cm}
\def\cornerlength{0.2cm}
\setlist[itemize]{leftmargin=*,noitemsep,topsep=0.1em,font=\Large}



\tikzset{
	objecttalk/.style    = {object,rounded corners,inner sep = 0.5 em,  node distance = 4cm},
	group/.style      = {color=black,thin,rounded corners=0.8em, line width=1pt,rectangle,fill = black!5}, 
	instarr/.style    = {latex-latex,line width = 2.5pt, draw = black!50 },
	instarrblue/.style    = {instarr,line width=4pt,draw = blue },
	archobject/.style    = {
		fill=black!5,draw,
		thick, rectangle, 
		minimum height = 1em,
		minimum width = 3em, 
		align=center, 
		inner sep=0.5em,
		node distance=4.2em and 4em,
		font = \scriptsize
	},
	sim/.style    = {
		archobject,
		fill = orange!40,
		draw = orange!60,
		text = orange!40
	},
	annotation/.style ={		
		align = left,
		minimum height = 1em,
		minimum width = 10em, 
		xshift = -1.5cm,
		text width=8em
	},
	hline/.style ={
		yshift = 1.5cm,
		color = black!50,
		thick,
		opacity = 0.5
	},
	class/.style= {
		draw= black!30,
		rounded corners=0.2cm,
		inner sep = 0.7em
	},
	docborder/.style= {
		draw,
		thick
	},
	plan/.style= {
		text width = 1.5cm,
		minimum height = 1.5cm,
		font = \scriptsize,
		align =  left
	}				
}

\begin{document}
	
	
	
\footnotesize
\pgfdeclarelayer{bbackground layer}
\pgfdeclarelayer{background layer}
\pgfdeclarelayer{foreground layer}
\pgfsetlayers{bbackground layer,background layer,main,foreground layer}

	\begin{tikzpicture}[]
	
	
	\draw
	node[archobject](bluesky){Bluesky Run Engine}
	
	% Ophyd
	node[archobject,below = of bluesky, yshift = -0.0cm](dosing_ophy){Gas Dosing\\\tiny Ophyd Device}	
	node[archobject,right = of dosing_ophy](reactor_ophy){Reactor Cell\\\tiny Ophyd Device}


	
	

	% Field
	node[archobject,below  of = dosing_ophy, yshift = -0.8cm](gas_dosing){Gas Dosing\\\tiny SHALL-LabVIEW}
	node[archobject,below  of =  reactor_ophy, yshift = -0.8cm](reactor_cell){Reactor Cell\\\tiny SHALL-LabVIEW}
	node[archobject,left   = of  gas_dosing, opacity = 0.5](gas_ana){Gas Analysis\\\tiny SHALL-LabVIEW}
	
	
	node[archobject,above  = of gas_ana,yshift = 0.013cm, opacity = 0.5](ana_ophy){Gas Analysis\\\tiny Ophyd Device}
	
	node [annotation,left of = gas_ana,xshift = -0.3cm] (field) {Field\\ Layer}	
	

	node [
		draw = orange!70,
		left of = gas_ana,
		xshift = -0.3cm,
		yshift = 1.3cm,
		font = \scriptsize,
		fill = orange!40,
		rounded corners=0.2cm,
		minimum height = 2em,
		minimum width= 8.5em,
		xshift = -1.7cm,
		text width=8em,
		inner sep = 0.4em
		] (sim_nodes){Containerised Simulated Hardware} 
	

	
	% Hardware
	node[archobject,below  of =gas_ana] (spectr) {Mass \\Spectrometer}
	
	node [annotation,left of = spectr,xshift = -0.3cm] (hard) {Hardware\\Components}	
	
	node[archobject,below of = gas_dosing](massflow){ 3x Massflow Contr.\\ 1x Pressure Contr.}
	node[archobject,below  of = reactor_cell](temp_contr){Temperature Contr.\\
		Temperarture Sensor}		
	

	
	node[plan,left  = of  bluesky](plan){Plan:\\Catalysis\\ Experiment}		
	
	
	node[plan,right  = of  bluesky](doc){Bluesky\\Documents}	
	
	node [annotation,left of = plan,xshift = -0.cm] (ecs) {Experimental Control System}
	
	
	;
	
	\begin{pgfonlayer}{background layer}
		% Sample Environment
		\node[class,fill = green!5,fit = {(spectr) (reactor_cell) (temp_contr)}](sample_env){};
		

		
		% Bluesky environment
		\node[class,fill = blue!5,fit = {(bluesky) (dosing_ophy) (reactor_ophy) (plan)(doc)}](bluesky_env){};
	
		
		% Sim Devices
		\node[sim,below  of = dosing_ophy, yshift = -0.7cm,xshift = 0.1cm](gas_dosing_sim){Gas Dosing\\\tiny SHALL-LabVIEW};
		\node[sim,below  of =  reactor_ophy, yshift = -0.7cm,xshift=0.1cm](reactor_cell_sim){Reactor Cell\\\tiny SHALL-LabVIEW};
		
		\node[sim,left   = of  gas_dosing,xshift = 0.1cm,yshift = 0.1cm](gas_ana_sim){Gas Analysis\\\tiny SHALL-LabVIEW};
		
		
		

	\end{pgfonlayer}

	\begin{pgfonlayer}{bbackground layer}
		\node [box,inner sep=2em,line width=0.5mm,fit = {(sample_env)(bluesky_env)(ecs)}]	(all){};
	\end{pgfonlayer}	

	
	
	
	\draw [docborder]
	(plan.north west)
	-- ([xshift=-\cornerlength]plan.north east)
	-- ([yshift=-\cornerlength]plan.north east)
	-- (plan.south east)
	-- (plan.south west)
	-- cycle;
	\draw [docborder]
	([yshift=-\cornerlength]plan.north east)
	-| ([xshift=-\cornerlength]plan.north east);
	
	\draw [docborder]
	(doc.north west)
	-- ([xshift=-\cornerlength]doc.north east)
	-- ([yshift=-\cornerlength]doc.north east)
	-- (doc.south east)
	-- (doc.south west)
	-- cycle;
	\draw [docborder]
	([yshift=-\cornerlength]doc.north east)
	-| ([xshift=-\cornerlength]doc.north east);
	
	
	\draw[hline] ([yshift=0.3cm] field.north west) -- ([yshift=0.3cm,xshift = 11.5cm] field.north west);
	
	\draw[hline] ( [yshift=0.3cm] hard.north west) -- ([yshift=0.3cm,xshift = 11.5cm] hard.north west);
	
	\draw[hline] ([xshift = -0.2cm,yshift= 0.5cm]ecs.north east) -- ([xshift = -0.2cm,yshift = -0.2cm]hard.south east);
	
	
	
	\draw[] (reactor_cell) -- (temp_contr);
	\draw[] (massflow) -- (gas_dosing);			
	\draw[opacity = 0.5] (spectr) -- (gas_ana);		

	\draw[]	(reactor_cell) -- (reactor_ophy)node [midway, above, sloped,font =\small] (TextNode) {SECoP};
	\draw[]	(gas_dosing) -- (dosing_ophy)node [midway, above, sloped,font =\small] (TextNode) {SECoP};
	\draw[ opacity = 0.5]	(gas_ana) -- (ana_ophy)node [midway, above, sloped,font =\small, opacity = 0.5] (TextNode) {SECoP};
	

	\draw[] (dosing_ophy) -- (bluesky);
	
	

	
	

	\draw[] (reactor_ophy.north)|-([yshift = 0.5cm] reactor_ophy.north) -| (bluesky);
	\draw[opacity = 0.5] (ana_ophy.north)|-([yshift = 0.5cm] ana_ophy.north) -| (bluesky);
	\draw[-Stealth,thick] (plan) -- (bluesky);
	\draw[-Stealth,thick] (bluesky) -- (doc);
	
	
	\begin{pgfonlayer}{background layer}

		\draw [orange!60] (sim_nodes) to [out=0,in=120] (gas_ana_sim); 
		\draw [orange!60] (sim_nodes) to [out=0,in=160] (gas_dosing_sim);
		\draw [orange!60] (sim_nodes) to [out=0,in=165] (reactor_cell_sim);
		
		
		
	\end{pgfonlayer}
	

	
	
\end{tikzpicture}



	
	
	
\end{document}